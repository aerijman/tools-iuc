<tool name='fgbio Find Switchback Reads' id='find_switchBackReads' version="@TOOL_VERSION@.@WRAPPER_VERSION@">
  <description>Finds reads where a template switch occurred during library construction</description>
  <macros>
    <import>fgbio_macros.xml</import>
    <token name="@WRAPPER_VERSION@">1</token>
  </macros>
  <expand macro="requirements">
    <requirement type="package" version="0.8.1">r-base</requirement>
  </expand>
  <command detect_errors="exit_code"><![CDATA[
    @java_options@
    @symlink_element_identifier@
    
    #set $reference_fasta_filename = "localref.fa"
    @handle_reference_source@
    
    java -Xmx8g -XX:+AggressiveOpts -XX:+AggressiveHeap -jar fgbio-0.8.1.jar FindSwitchbackReads  
    --input='$escaped_element_identifier'
    --outpupt='OutPut.bam'
    --metrics=s1.switchback
    --ref='${reference_fasta_filename}'
    --max-offset=${max_offset}
    --max-gap='${max_gap}'
    --min_length='${min_length}'
    --max_error_rate='${max_error_rate}'
    --dont_unmap='${dont_unmap}';
  ]]></command>  
  <inputs>
    <param name='inputFile' format="sam,bam" type='data' label='SAM/BAM Input file'/>
    <conditional name="reference_source">
      <param name="reference_source_selector" type="select" label="Load reference genome from">
        <option value="cached">Local cache</option>
        <option value="history">History</option>
      </param>
      <when value="cached">
        <param name="ref_file" type="select" label="Use dictionary from the list" help="Select genome from the list">
          <options from_data_table="fgbio_indexes">
            <filter type="sort_by" column="2" />
            <validator type="no_options" message="No indexes are available" />
          </options>
          <validator type="no_options" message="A built-in dictionary is not available for the build associated with the selected input file"/>
        </param>
      </when>
      <when value="history">
        <param name="ref_file" type="data" format="fasta" label="Use the following dataset to create dictionary" help="You can upload a FASTA sequence to the history" />
      </when>
    </conditional>
  
    <param name='max_offset' value="35" type='integer' label="how far away to search for the reverse-complemented sequence" help="The default value of 35 allows matches to be found when the soft-clipped sequence matches the genome starting at most 35bp from the 5prime mapped position of the read, and reading in the opposite direction."/>
    <param name="max_gap" value="500" type="integer" label=" causes the tool to only identify a tandem read pair as a switch-back if the gap between the end of the first read and the start of the second read is +/- max-gap." />
    <param name='min_length' value="6" type='integer' label="controls the minimum number of soft-clipped bases that must exist to trigger the search." help="Given that the search looks at 2 * max-offset locations (default=70) it is important that min-length is set such that 4^min-length >> 2 * max-offset` in order to avoid false positives."/>
    <param name="max_error_rate" type="integer" value="0.1" label="allows for some mismatches to exist between the soft-clipped sequence and the genome when matching."/>
    <param name="dont unmap" type="boolean" checked="false" truevalue="true" falsevalue="false" label="dont map reads when when a switch-back template is identified"/>

    <expand macro="VS" />

  </inputs>

  <outputs>
    <data name='Output.bam' format="bam"  from_work_dir="OutPut.bam" label='Output bam file where (unless dont_unmap was specified) primary reads are made unmapped if Switchback identified'/>
    <data name='gaps' format="tabular"  from_work_dir="s1.switchback.gaps.txt" label=' A table of the distribution of gap lengths in tampl'/>
    <data name='offsets' format="tabular"  from_work_dir="s1.switchback.offsets.txt" label=' A table of the distribution of observed offsets in read-based switchbacks.'/>
    <data name='lengths' format="tabular"  from_work_dir="s1.switchback.lengths.txt" label='A table of the distribution of observed switchback lengths in read-based switchbacks.'/>
    <data name='summary' format="tabular"  from_work_dir="s1.switchback.summary.txt" label='A table of summary metrics describing the number of reads, switchbacks, etc.'/>
    <data name='plot' format="pdf"  from_work_dir="s1.switchback.plots.pdf" label='A PDF containing plots of the distributions from 2-4.'/>
  </outputs>
  
  <tests>
    <test>
      <param name="inputFile" value="picard_ARRG_test1.bam" ftype="bam" />
      <param name="reference_source_selector" value="history"/>
      <param name="ref_file" value="picard_BedToIntervalList_ref.fa" />
      <!--<param name="context_size" value="1" />
      <param name="contexts_to_print" value="AAA,CAA,AAC,AAT,AAG" />
      <output name='pre_details' file='pre_details' ftype="tabular"  value="pre_detail" lines_diff="4"/>
      <output name='pre_summary' file='pre_summary' ftype="tabular"  value="pre_summary" lines_diff="4"/>
      <output name='pos_details' file='pos_details' ftype="tabular"  value="pos_detail" lines_diff="4"/>
      <output name='pos_summary' file='pos_summary' ftype="tabular"  value="pos_summary" lines_diff="4"/>
      <output name='err_summary' file='err_summary' ftype="tabular"  value="err_summary" lines_diff="4"/>-->
    </test>
  </tests>


  <help>

.. class:: infomark

**Purpose**

Program to chart the distribution of potential sequencing "single nucleotide mutation" artifacts in a SAM or BAM file.

@dataset_collections@

@description@

  ASSUME_SORTED=Boolean           If true (default), then the sort order in the header file will be ignored.  
                                  Default: True

  CONTEXT_SIZE=integer            The number of context bases to include on each side of the assayed base.
  
  CONTEXT_SIZE_TO_PRINT=String    If specified, only print results for these contexts in the detail metrics output. 
                                  However, the summary metrics output will still take all contexts into consideration.
                                
  DB_SNP=text file                VCF format dbSNP file, used to exclude regions around known polymorphisms from analysis.

  INCLUDE_DUPLICATES=Boolean      Include duplicate reads. If set to true then all reads flagged as duplicates will be included as well.

  INCLUDE_UNPAIRED=Boolean        Include unpaired reads. If set to true then all paired reads will be included as well - 
                                  MINIMUM_INSERT_SIZE and MAXIMUM_INSERT_SIZE will be ignored.

  MAXIMUM_INSERT_SIZE=Integer     The maximum insert size for a read to be included in analysis. Set to 0 to have no maximum.
                                  Default = 600

  MINIMUM_INSERT_SIZE=Integer     The minimum insert size for a read to be included in analysis. Default = 60

  MINIMUM_MAPPING_QUALITY         The minimum mapping quality score for a base to be included in analysis. Default = 30

  MINIMUM_QUALITY_SCORE           The minimum base quality score for a base to be included in analysis. Default = 20

@more_info@

  </help>
  <expand macro="citations" />
</tool>
