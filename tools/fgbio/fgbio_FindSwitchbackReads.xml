<tool name='fgbio Find Switchback Reads' id='find_switchBackReads' version="@TOOL_VERSION@.@WRAPPER_VERSION@">
  <description>Finds reads where a template switch occurred during library construction</description>
  <macros>
    <import>fgbio_macros.xml</import>
    <token name="@WRAPPER_VERSION@">1</token>
  </macros>
  <expand macro="requirements">
    <requirement type="package" version="0.8.1">r-base</requirement>
  </expand>
  <command detect_errors="exit_code"><![CDATA[
    @java_options@
    @symlink_element_identifier@
    
    #set $reference_fasta_filename = "localref.fa"
    @handle_reference_source@
    
    java -Xmx8g -XX:+AggressiveOpts -XX:+AggressiveHeap -jar /Users/aerijman/Documents/projects/fgbio-0.8.1.jar FindSwitchbackReads  
    --input='$escaped_element_identifier'
    --output='OutPut.bam'
    --metrics=s1.switchback
    --ref='${reference_fasta_filename}'
    --max-offset=${max_offset}
    --max-gap='${max_gap}'
    --min-length='${min_length}'
    --max-error-rate='${max_error_rate}'
    --dont-unmap='${dont_unmap}'
    --sort-order='Coordinate';
  ]]></command>  
  <inputs>
    <param name='inputFile' format="sam,bam" type='data' label='BAM Input file'/>
    <conditional name="reference_source">
      <param name="reference_source_selector" type="select" label="Load reference genome from">
        <option value="cached">Local cache</option>
        <option value="history">History</option>
      </param>
      <when value="cached">
        <param name="ref_file" type="select" label="Use dictionary from the list" help="Select genome from the list">
          <options from_data_table="fgbio_indexes">
            <filter type="sort_by" column="2" />
            <validator type="no_options" message="No indexes are available" />
          </options>
          <validator type="no_options" message="A built-in dictionary is not available for the build associated with the selected input file"/>
        </param>
      </when>
      <when value="history">
        <param name="ref_file" type="data" format="fasta" label="Use the following dataset to create dictionary" help="You can upload a FASTA sequence to the history" />
      </when>
    </conditional>
  
    <param name='max_offset' value="35" type='integer' label="Maximum offset between ends of the two segments of the read on the reference" help="The default value of 35 allows matches to be found when the soft-clipped sequence matches the genome starting at most 35bp from the 5prime mapped position of the read, and reading in the opposite direction."/>
    <param name="max_gap" value="500" type="integer" label="Maximum gap between R1 and R2 of tandem reads to call a template a switchback." help="Causes the tool to only identify a tandem read pair as a switch-back if the gap between the end of the first read and the start of the second read is +/- max-gap." />
    <param name='min_length' value="6" type='integer' label="Minimum match length of the switched back segment" help="Controls the minimum number of soft-clipped bases that must exist to trigger the search. Given that the search looks at 2 * max-offset locations (default=70) it is important that min-length is set such that 4^min-length >> 2 * max-offset` in order to avoid false positives."/>
    <param name="max_error_rate" type="float" value="0.1" label="Maximum mismatch error rate of switchback match to genome." help="Allows for some mismatches to exist between the soft-clipped sequence and the genome when matching."/>
    <param name="dont_unmap" type="boolean" checked="false" truevalue="true" falsevalue="false" label="IF true, do NOT unmap reads from switchback templates." help="Dont map reads when when a switch-back template is identified."/>

    <expand macro="VS" />

  </inputs>

  <outputs>
    <data name='Output.bam' format="bam"  from_work_dir="OutPut.bam" label='Output bam file where (unless dont_unmap was specified) primary reads are made unmapped if Switchback identified'/>
    <data name='gaps' format="tabular"  from_work_dir="s1.switchback.gaps.txt" label=' A table of the distribution of gap lengths in tampl'/>
    <data name='offsets' format="tabular"  from_work_dir="s1.switchback.offsets.txt" label=' A table of the distribution of observed offsets in read-based switchbacks.'/>
    <data name='lengths' format="tabular"  from_work_dir="s1.switchback.lengths.txt" label='A table of the distribution of observed switchback lengths in read-based switchbacks.'/>
    <data name='summary' format="tabular"  from_work_dir="s1.switchback.summary.txt" label='A table of summary metrics describing the number of reads, switchbacks, etc.'/>
    <data name='plot' format="pdf"  from_work_dir="s1.switchback.plots.pdf" label='A PDF containing plots of the distributions from 2-4.'/>
  </outputs>
  
  <tests>
    <test>
      <param name="inputFile" value="picard_ARRG_test1.bam" ftype="bam" />
      <param name="reference_source_selector" value="history"/>
      <param name="ref_file" value="picard_BedToIntervalList_ref.fa" />
      <!--<param name="context_size" value="1" />
      <param name="contexts_to_print" value="AAA,CAA,AAC,AAT,AAG" />
      <output name='pre_details' file='pre_details' ftype="tabular"  value="pre_detail" lines_diff="4"/>
      <output name='pre_summary' file='pre_summary' ftype="tabular"  value="pre_summary" lines_diff="4"/>
      <output name='pos_details' file='pos_details' ftype="tabular"  value="pos_detail" lines_diff="4"/>
      <output name='pos_summary' file='pos_summary' ftype="tabular"  value="pos_summary" lines_diff="4"/>
      <output name='err_summary' file='err_summary' ftype="tabular"  value="err_summary" lines_diff="4"/>-->
    </test>
  </tests>


  <help>

.. class:: infomark

**Purpose**

Program to identify swichback artifacts in a BAM file.

@dataset_collections@

@description@

  MAX-OFFSET = Integer              Maximum offset between ends of the two segments of the read on the reference. Set to 0 to
                                    disable read-based checks. [Default: 35]  
                                  
  MAX-GAP = integer                 Maximum gap between R1 and R2 of tandem reads to call a template a switchback. Set to 0
                                    to disable tandem-based checks. [Default: 500].
  
  MIN-LENGTH = Integer              Minimum match length of the switched back segment. [Default: 6]. 
                                
  MAX-ERROR = text file             Maximum mismatch error rate of switchback match to genome. [Default: 0.1].

  DONT-UNMAP = Boolean              IF true, do NOT unmap reads from switchback templates. [Default: false].

@more_info@

  </help>
  <expand macro="citations" />
</tool>
