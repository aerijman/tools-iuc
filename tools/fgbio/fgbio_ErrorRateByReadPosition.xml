<tool name='fgbio Error Rate By Read Position' id='ErrorRateByReadPosition' version="@TOOL_VERSION@.@WRAPPER_VERSION@">
  <description>Finds reads where a template switch occurred during library construction</description>
  <macros>
    <import>fgbio_macros.xml</import>
    <token name="@WRAPPER_VERSION@">1</token>
  </macros>
  <expand macro="requirements">
    <requirement type="package">r-base</requirement>
    <requirement type="package">r-ggplot2</requirement>
  </expand>
  <command detect_errors="exit_code"><![CDATA[
    @java_options@
    @symlink_element_identifier@
    
    #set $reference_fasta_filename = "localref.fa"
    @handle_reference_source@


    fgbio ErrorRateByReadPosition
    --input='$escaped_element_identifier'
    --output='table'
    --ref='${reference_fasta_filename}'
    --include-duplicates='${include_duplicates}'
    --min-mapping-quality='${min_mapping_quality}'
    --min-base-quality='${min_base_quality}'
  ]]></command>

  <inputs>
    <param name='inputFile' format="bam" type='data' label='BAM Input file'/>
    <conditional name="reference_source">
      <param name="reference_source_selector" type="select" label="Load reference genome from">
        <option value="cached">Local cache</option>
        <option value="history">History</option>
      </param>
      <when value="cached">
        <param name="ref_file" type="select" label="Use dictionary from the list" help="Select genome from the list">
          <options from_data_table="picard_indexes">
            <filter type="sort_by" column="2" />
            <validator type="no_options" message="No indexes are available" />
          </options>
          <validator type="no_options" message="A built-in dictionary is not available for the build associated with the selected input file"/>
        </param>
      </when>
      <when value="history">
        <param name="ref_file" type="data" format="fasta" label="Use the following dataset to create dictionary" help="You can upload a FASTA sequence to the history" />
      </when>
    </conditional>
  
    <!-- ToDo add \-\- variants=${path_to_vcf} and \-\-intervals='${path_to_intervals}' in a later version -->
    <param name='min_mapping_quality' value="20" type='integer' label="Minimum mapping quality" help="The minimum mapping quality for a read to be included."/>
    <param name="min_base_quality" value="0" type="integer" label="Min Base Quality" help="The minimum base quality for a base to be included."/>
    <param name="include_duplicates" type="boolean" checked="false" truevalue="true" falsevalue="false" label="Include Duplicate Reads" help="Include duplicate reads, otherwise ignore." />

    <expand macro="VS" />
  </inputs>

  <outputs>
    <data name='table' format="tabular" from_work_dir="table.error_rate_by_read_position.txt" label='table with the data' />
    
  </outputs>
  
  <tests>
    <test>
      <param name="inputFile" value="picard_ARRG_test1.bam" ftype="bam" />
      <param name="reference_source_selector" value="history"/>
      <param name="ref_file" value="picard_BedToIntervalList_ref.fa" />
      <output name='table' file='table.error_rate_by_read_position.txt' ftype="tabular"  value="table.error_rate_by_read_position.txt" lines_diff="4"/>
    </test>
    <test>
      <param name="inputFile" value="picard_ARRG_test1.bam" ftype="bam" dbkey="hg38"/>
      <output name='table' file='table.error_rate_by_read_position.txt' ftype="tabular"  value="table.error_rate_by_read_position.txt" lines_diff="4"/>
      <param name="reference_source_selector" value="cached"/>
    </test>
  </tests>


  <help>

.. class:: infomark

**Purpose**

Calculates the error rate by read position on coordinate sorted mapped BAMs. The output file contains a row per read (first of pair, second of pair and unpaired), per position in read, with the total number of bases observed, the number of errors observed, the overall error rate, and the rate of each kind of substitution error.
Substitution types are collapsed based on the reference or expected base, with only six substitution types being reported: A>C, A>G, A>T, C>A, C>G and C>T. For example, T>G is grouped in with A>C.

@description@

  INCLUDE-DUPLICATES = Boolean     Include duplicate reads, otherwise ignore. [Default: false]

  MIN-MAPPING-QUALITY = Integer    The minimum mapping quality for a read to be included. [Default: 20]  
                                  
  MIN-BASE-QUALITY = integer       The minimum base quality for a base to be included. [Default: 0]
  
@more_info@

  </help>
  <expand macro="citations" />
</tool>
