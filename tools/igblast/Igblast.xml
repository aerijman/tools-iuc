<tool id="igblast" name="Igblast tool" version="1.15.0">
  <requirements>
    <requirement type="package" version="1.15.0">igblast</requirement> 
  </requirements>
  <command detect_errors="exit_code">
    <![CDATA[
   
    igblastn \
    -ig_seqtype '${seqtype}' \
    -num_threads 20 \
    -germline_db_V '${germline_db_V}' \
    -germline_db_J '${germline_db_J}' \
    -germline_db_D '${germline_db_D}' \
    -organism '${organism}' \
    -auxiliary_data '${auxiliary_data}' \
    -query <(python test-data/fastq2fasta.py -in '${fastq_input}')

  ]]></command>
  <inputs>
    <!-- Fastq input file -->
    <param type="data" name="fastq_input" label="Fastq input file" format="fastq" help="fastq input file. This could be the output of pResto workflow"/>
    <!-- ig sequence type -->
    <param type="select" display="radio" name="seqtype" label="Sequence type">
      <option value="TCR">TCR</option>
      <option value="IG" selected="True">Ig</option> 
    </param>
    <!-- references datasets -->
    <param type="data" name="germline_db_V" label="Germline db V" format="fa" help="Dataset with V sequence"/>
    <param type="data" name="germline_db_D" label="Germline db D" format="fa" help="Dataset with D sequence"/>
    <param type="data" name="germline_db_J" label="Germline db J" format="fa" help="Dataset with J sequence"/>            
    <!-- organism -->       
    <!--<param name="organism" label="Organism" type="select" help="human, mouse, etc."/>-->
    <!-- Additional parameters -->
    <param type="data" name="auxiliary_data" label="optional_file" optional="true" format="text" help="germline J gene coding frame start position (position is 0-based), the J gene type, and the CDR3 end position for each sequence in the germline J sequence database (Fields are tab-delimited). Only for NCBI or IMGT germline gene sequence database"/>
  </inputs>

  <outputs>
    <data name="output" format="txt" />
  </outputs>

  <tests>
    <test>
      <param name="fasta_input" value="test2.bam" ftype="bam"/>
      <param name="seqtype" value="TCR"/>
      <param name="germline_db_V" value="database/tr_v"/>
      <param name="germline_db_J" value="database/tr_j"/>
      <param name="germline_db_D" value="database/tr_d"/>
      <param name="auxiliary_data" value="database/human_gl.aux" ftype="bed"/>
      <output name="output" file="test.output" lines_diff="4"/>
    </test>
  </tests>

  <help>
    <![CDATA[

**What it does**

This tool counts the number/proportion of mismatches per position along the read, 
for each read (see figure below).

.. image:: ${static_path}/images/snapshot_good.jpg
    :height: 350                                                            
    :width: 650   

-----

**What is special**

By providing a bed file, tasmanian-mismatch will count mismatches from all regions depicted in the figure below, 
and will report them separately. Also, a parameter defined as *"confidence"* allows including reads with >=
bases in the boundary region in a separate group. This is useful when the bed refers to repeat regions. Since these 
regions might not have been correctly placed in the assembly or are not the same in different individuals, we can 
include this *confidence* repeat regions where we have high confidence on the reference genome to which we mapped the reads.

.. image:: ${static_path}/images/intersections_tasmanian.jpg                
    :height: 150                                                            
    :width: 650 

Softclips are critical in FFPE (Formalin-fixed paraffin-embedded) experiments as mismatches tend to accumulate at the ends of the reads. Most often, softclips 
are all accepted during the analysis and many real mismatches are indirectly excluded from the analysis. Hence, this tool 
provides different ways to deal with this: 

The *softclips* field allows for 3 different ways at treating softclips:    
0) Exclude these region if there is less than 2/3 identity with the reference genome  
1) Exclude all softclipped bases  
2) Include all softclipped bases  

.. class:: warningmark   

BAM/SAM file must be **sorted** if not using a bed file.
  
    ]]>
  </help>
  <citations>
    <citation type="bibtex">
      @misc{githubtasmanian,
        author = {Langhorst B., Others, Erijman A.},
        year = {2020},
        title = {TBD},
        publisher = {GitHub},
        journal = {GitHub repository},
        url = {https://github.com/nebiolabs/tasmanian-mismatch},
      }
    </citation>
  </citations>
</tool>
