<tool id="presto_alignsets" name="pRESTO AlignSets" version="@TOOL_VERSION@+galaxy1">
    <description>Multiple-align sequences with the same barcodes.</description>
       
    <macros>
        <import>presto_macros.xml</import>
    </macros>

    <requirements>
        <requirement type="package" version="@TOOL_VERSION@">presto</requirement>
        <requirement type="package" version="@MUSCLE_VERSION@">muscle</requirement>
    </requirements>

    <version_command>AlignSets.py --version</version_command>
    <command detect_errors="exit_code"><![CDATA[
        #if $methodo.selector == "muscle"
			ln -s '$fastq_in' in.fastq &&
		#else if $methodo.selector == "table"
			ln -s '$primer_fa' in.fasta && 
        #end if
        echo "the method is ***************** $methodo********************** " && 
        AlignSets.py '$methodo' 
          --nproc "\${GALAXY_SLOTS:-1}"
          --outname=tmp 
          #if $methodo.selector == "muscle"
              -s in.fastq
              --bf '$bf'
              $div
          #else if $methodo.selector == "table"
              -p in.fasta
              --exec '$(which conda)'
              $reverse
          #end if
          #if $capture_log
            --log '$log_out'
          #end if
    ]]></command>

	<inputs>
		<conditional name="methodo">
			<param name="selector" type="select" label="Alignment method" help="This step is to correct missalignment that is due to different primers in the multiplex pool having been incorporated into the same UMI read group during amplification if the primers are sufficiently similar.">
				<option value="muscle" selected="True">Align sequence sets using muscle (muscle)</option>
				<option value="offset">Align sequence sets using predefined 5' offset (offset)</option>
				<option value="table">Create a 5' offset table by primer multiple alignment (table)</option>
			</param>
			<when value="muscle">	
				<param argument="-s" name="fastq_in" type="data" format="fastq" label="Input FASTQ file" help="FASTQ file of sequences with barcodes/UMIs in an annotation."/>
				<param argument="--bf" type="text" value="BARCODE" label="Barcode Field" help="Name of the annotation field which contains the barcode/UMI sequence."/>
				<param argument="--div" type="boolean" value="false" truevalue="--div" falsevalue="" label="Calculate Nucleotide Diversity" help="Specify to calculate nucleotide diversity of each set."/>
			</when>
			<when value="table">
				<param argument="-p" name="primer_fa" type="data" format="fasta" label="The primer field to use for offset assignment."/>
				<param argument="--reverse" type="boolean" value="false" truevalue="--reverse" falsevalue="" label="reverse 5' to 3'" help="If specified create a 3â€™ offset table instead"/> 
			</when>
			<when value="offset">
			</when>
		</conditional>
        <expand macro="presto-log-param"/>
    </inputs>

    <outputs>
        <data name="fastq_out" format="fastq" from_work_dir="tmp_align-pass.fastq"/>
        <!--<data name="fasta_out" format="fasta" from_work_dir="tmp_align-pass.fasta"/>-->
        <expand macro="presto-log-output"/>
    </outputs>
    
    <tests>
		<test>
			<param name="methodo" value="muscle"/> 
            <param name="fastq_in" value="presto_alignsets_test_in.fastq"/>
            <output name="fastq_out" file="presto_alignsets_test_out.fastq" compare="sim_size" delta="15"/>
        </test>
        <!--
        <test>
            <!-\-AlignSets.py table -p test-data/read2_primers.fasta -\-exec $(which muscle) -\-reverse -\->
            <param name="methodo" value="table"/>
            <param name="primer_fa" value="read2_primers.fasta"/>
            <param name="reverse" value="true"/>
            <output name="fasta_out" file="read2_primers_offsets-reverse.tab" lines_diff="1"/>
        </test>
        -->
    </tests>
    
    <help><![CDATA[
Multiple aligns sequences with the same barcode to correct for any misalignments due to either different primer usage or insertions/deletions in the sequences.

Only supports the "muscle" sub-command of pRESTO's AlignSets.py.

See the `pRESTO online help <@PRESTO_BASE_URL@/en/stable>`_ for more information.

@HELP_NOTE@
    ]]></help>
    <expand macro="citations" />
</tool>
